---
title: "Tipos de filme de FULANO(A)"
output:
    html_document:
    df_print: paged
theme: sandstone
---

```{r echo=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(here)
library(cluster)
library(plotly)
library(ggdendro)
library(ggbeeswarm)
library(broom)

source(here::here("code/lib.R"))
theme_set(theme_report())

knitr::opts_chunk$set(tidy = FALSE,
                      fig.width = 6,
                      fig.height = 5,
                      echo = TRUE)

paleta = c("#404E4D",
           "#92DCE5",
           "#938BA1",
           "#2D3142",
           "#F4743B")
```

```{r}
## ANTES DE USAR
# Para criar data/movies.csv
import_data("/liam_neeson") # ou com o ator/atriz que você escolher
```


```{r read}
filmes = read_imported_data()
```

## Descrição

```{r}
filmes %>% 
    ggplot(aes(x = ano, y = bilheteria)) + 
    geom_point(size = 4, color = paleta[1]) 
```



```{r}
filmes %>% 
    ggplot(aes(x = bilheteria)) + 
    geom_histogram(binwidth = 15, fill = paleta[2], color = "black") + 
    geom_rug(size = .5) 
```

```{r}
filmes %>% 
    ggplot(aes(x = avaliacao)) + 
    geom_histogram(binwidth = 10, boundary = 0, fill = paleta[3], color = "black") + 
    geom_rug(size = .5) 
```

## Estrutura de grupos?

```{r}
p = filmes %>% 
    ggplot(aes(x = "", y = bilheteria, label = filme)) + 
    geom_jitter(width = .05, alpha = .3, size = 3) + 
    labs(x = "")

ggplotly(p)
```

## Agrupamento hierárquico

```{r}
```


```{r}
agrupamento_h <- filmes %>% 
    mutate(bilheteria =  log10(bilheteria))%>%
    mutate_at(vars(avaliacao, bilheteria), funs(scale)) %>%
    as.data.frame()%>% 
    column_to_rownames("filme") %>% 
    select(avaliacao, bilheteria) %>%
    dist(method = "euclidian") %>% 
    hclust(method = "ward.D")
ggdendrogram(agrupamento_h, rotate = T, size = 2, theme_dendro = F) + 
    labs(y = "Dissimilaridade", x = "", title = "Dendrograma")

```
```{r}
get_grupos <- function(agrupamento, num_grupos){
    agrupamento %>% 
        cutree(num_grupos) %>% 
        as.data.frame() %>% 
        mutate(label = rownames(.)) %>% 
        gather(key =  "k", value = "grupo", -label) %>% 
        mutate(grupo = as.character(grupo))
}
atribuicoes = get_grupos(agrupamento_h, num_grupos = 1:6)
atribuicoes = atribuicoes %>% 
    left_join(filmes, by = c("label" = "filme"))
 q = atribuicoes %>% 
    ggplot(aes(x = bilheteria, y = avaliacao, colour = grupo)) + 
    geom_jitter(width = .02, height = 0, size = 1.6, alpha = .6) + 
    facet_wrap(~ paste(k, " grupos")) + 
    scale_color_brewer(palette = "Dark2")
 
 ggplotly(p)
```
```{r}
k_escolhido = 4
 atribuicoes %>% 
    filter(k == k_escolhido) %>% 
    ggplot(aes(x = reorder(label, avaliacao), y = avaliacao, colour = grupo)) + 
    geom_jitter(width = .02, height = 0, size = 3, alpha = .6) + 
    facet_wrap(~ paste(k, " grupos")) + 
    scale_color_brewer(palette = "Dark2") + 
    labs(x = "", y = "Avaliação RT") + 
    coord_flip() 
```


```{r}
m_transformado = filmes %>% 
    mutate(bilheteria_log = log10(bilheteria))
summary(m_transformado %>% select(bilheteria, bilheteria_log))
```


```{r}
m_transformado = filmes %>%
    mutate(bilheteria_log_scaled = as.vector(scale(log10(bilheteria))),
           avaliacao_scaled = as.vector(scale(avaliacao)))

m_transformado %>% 
    select(bilheteria_log_scaled, avaliacao_scaled) %>% 
    summary()
```
```{r}
n_clusters = 3

km = m_transformado %>%
    select(bilheteria_log_scaled, avaliacao_scaled) %>%
    kmeans(centers = n_clusters, nstart = 20)

agrupado = km %>% 
    augment(m_transformado)

agrupado %>%
    ggplot(aes(x = avaliacao_scaled, y = bilheteria_log_scaled, color = .cluster))  +
    geom_point(size = 2) 

agrupado %>%
    ggplot(aes(x = avaliacao, y = bilheteria, color = .cluster, label = filme))  +
    geom_point(size = 2) +
    scale_y_log10()
```


##Grupos
Podemos classificar os grupos de filmes em três categorias: 1- Fúria de Titãs. 2 - Cavaleiro das Trevas . 3 - Silêncio
ee

##Descrevendo os grupos:

##Grupo 1: Fúria de Titãs

Neste grupo estão localizados os filmes com avaliações médias e boas bilheterias que tem em sua maioria filmes com enredo de ação, onde Neeson interpreta personagens que tem alguma missão pra cumprir e alguém está querendo matá-lo. E para isso não faltam carros explodindo, cenas de luta e tiroteio pra todo lado.

##Grupo 2: Ra's Al Ghu

Neste grupos se situam os filmes que saem um pouco do perfil de filmes de ação de Neeson e possuem outras temáticas. São filmes com boa avaliação e bilheteria.

##Grupo 3: Fúria de titâs e outros fiascos:

Neste grupo têm-se os filmes com avaliações ruins e baixa bilheteria englobando filmes da saga Fúria de Titâs e Busca Implacável 2.


```{r}
p = agrupado %>%
    ggplot(aes(x = avaliacao, y = bilheteria, color = .cluster, label = filme))  +
    geom_point(size = 2) +
    scale_y_log10()

ggplotly(p)
```


```{r}
agrupa_bilheteria_avaliacao <- function(df, k){
    df %>% 
        select(bilheteria_log_scaled, avaliacao_scaled) %>%
        kmeans(centers = k, 
               nstart = 20) %>% 
        augment(df) %>% 
        mutate(.cluster = as.character(.cluster))
}

agrupamentos = tibble(k = 1:6) %>% 
    mutate(agrupamento = map(k, ~ agrupa_bilheteria_avaliacao(m_transformado, .))) %>% 
    unnest(agrupamento)
 
agrupamentos %>%
    ggplot(aes(
        x = avaliacao ,
        y = bilheteria,
        label = filme,
        colour = .cluster
    )) +
    geom_point(size = 2, alpha = .8) +
    facet_wrap( ~ k) +
    scale_y_log10()

```

```{r}
atribuicoes %>% 
    filter(k == n_clusters) %>% 
    ggplot(aes(x = reorder(label, avaliacao), y = avaliacao, colour = grupo)) + 
    geom_jitter(width = .02, height = 0, size = 3, alpha = .6) + 
    facet_wrap(~ paste(k, " grupos")) + 
    scale_color_brewer(palette = "Dark2") + 
    labs(x = "", y = "Avaliação RT") + 
    coord_flip() 
```


```{r}
plot_clusgap = function(clusgap, title = "Gap Statistic calculation results") {
    require("ggplot2")
    gstab = data.frame(clusgap$Tab, k = 1:nrow(clusgap$Tab))
    p = ggplot(gstab, aes(k, gap)) + geom_line() + geom_point(size = 5)
    p = p + geom_errorbar(aes(ymax = gap + SE.sim, ymin = gap - SE.sim), width = .2)
    p = p + ggtitle(title)
    return(p)
}
```

```{r}
gaps <- m_transformado %>% 
    select(bilheteria_log_scaled, avaliacao_scaled) %>% 
    clusGap(FUN = kmeans, nstart = 20, K.max = 8, B = 200)
plot_clusgap(gaps)
```



